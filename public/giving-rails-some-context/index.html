
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>giving rails some context - thoughts_on_rails</title>
  <meta name="author" content="James Martin">

  
  <meta name="description" content="There has been quite a bit of talk lately around the idea of model decomposition and DCI roles. In this post, we&#8217;ll look at one way to break up &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.thoughtsonrails.com/giving-rails-some-context/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="thoughts_on_rails" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-36531468-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">thoughts_on_rails</a></h1>
  
    <h2>a blog about ruby on rails</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.thoughtsonrails.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h2 class="entry-title">Giving Rails Some Context</h2>
    
    
      <p class="meta">
        








  


<time datetime="2012-12-24T17:59:00-05:00" pubdate data-updated="true">Dec 24<span>th</span>, 2012</time>
        
      </p>
    
  </header>


<div class="entry-content"><p>There has been quite a bit of talk lately around the idea of model decomposition and DCI roles.  In this post, we&#8217;ll look at one way to break up bloated models and include only what you need, when you need it.</p>

<!--more-->


<p>It&#8217;s becoming clear to more and more Rails developers that we need a method of breaking large models into smaller, more manageable chunks of code.
Rails 4 suggests <a href="https://gist.github.com/1014971">concerns</a> as one way to deal with the problem.  Personally, I like the idea of using contexts to bundle
up bits of similar code, for both the modularity and to keep models clean.</p>

<p>We&#8217;re going to write a gem that will allow us to create modules, or &#8216;contexts&#8217;, that can be applied selectively when creating new instances of Active Record models.
What we&#8217;re going for is something like this:</p>

<figure class='code'><figcaption><span>app/models/post.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_context</span> <span class="ss">:buyer</span><span class="p">,</span> <span class="n">with</span><span class="p">:</span> <span class="no">Buyer</span>
</span><span class='line'>  <span class="n">has_context</span> <span class="ss">:seller</span><span class="p">,</span> <span class="n">with</span><span class="p">:</span> <span class="o">[</span><span class="no">Seller</span><span class="p">,</span> <span class="no">Payable</span><span class="o">]</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>app/contexts/buyer.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">module</span> <span class="nn">Buyer</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">buy_item</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># buy an item</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c1">#...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>app/contexts/seller.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">module</span> <span class="nn">Seller</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">inventory</span>
</span><span class='line'>    <span class="c1"># list items</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c1">#...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>app/contexts/payable.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">module</span> <span class="nn">Payable</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">mark_paid</span><span class="p">(</span><span class="n">invoice</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># mark as paid</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c1">#...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span>console  </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">user</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:buy_item</span><span class="p">)</span>       <span class="c1">#=&gt; false</span>
</span><span class='line'><span class="n">buyer</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">with_context</span><span class="p">(</span><span class="ss">:buyer</span><span class="p">)</span>
</span><span class='line'><span class="n">buyer</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:buy_item</span><span class="p">)</span>      <span class="c1">#=&gt; true</span>
</span></code></pre></td></tr></table></div></figure>


<p>The code to accomplish this is pretty simple.</p>

<figure class='code'><figcaption><span>lib/contextual.rb </span></figcaption>
 <div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='rb'><span class='line'><span class="k">module</span> <span class="nn">Contextual</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>    <span class="n">mattr_accessor</span> <span class="ss">:contexts</span>
</span><span class='line'>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">contexts</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">has_context</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">opts</span><span class="o">=</span><span class="p">{})</span>
</span><span class='line'>      <span class="nb">self</span><span class="o">.</span><span class="n">contexts</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span> <span class="o">=</span> <span class="o">[</span><span class="n">opts</span><span class="o">[</span><span class="ss">:using</span><span class="o">]].</span><span class="n">flatten</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">with_context</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class='line'>      <span class="n">value</span> <span class="o">=</span> <span class="kp">new</span>
</span><span class='line'>      <span class="n">value</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:attr_accessor</span><span class="p">,</span> <span class="ss">:context</span><span class="p">)</span>
</span><span class='line'>      <span class="n">modules</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">contexts</span><span class="o">[</span><span class="nb">name</span><span class="o">]</span>
</span><span class='line'>      <span class="n">value</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="p">{</span><span class="nb">name</span> <span class="o">=&gt;</span> <span class="n">modules</span><span class="p">}</span>
</span><span class='line'>      <span class="n">modules</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
</span><span class='line'>        <span class="n">value</span><span class="o">.</span><span class="n">extend</span> <span class="n">m</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">value</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:include</span><span class="p">,</span> <span class="no">Contextual</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>We begin by extending ActiveSupport::Concern, which saves us the trouble of manually extending the including class with the ClassMethods module.
Inside of said module, we define a :context property and set it to an empty hash.  This will be our list of available contexts.</p>

<p>Next we define a &#8216;Class Macro&#8217; method, .has_context, that will allow the assignment of new contexts.  It takes a name and options hash as arguments.
The method just assigns the value of opts[:using] to the contexts hash under the key of the given name, making sure the assigned value is a flat array.</p>

<p>The next method, .with_context, is the instance factory.  It first creates a new instance, then calls send on it&#8217;s eigenclass, passing in :attr_accessor and :context as arguments.
This has the effect of creating a :context property on this instance alone.</p>

<p>The next couple of lines just grab the list of modules for the given context name and assigns the current context.  Then it&#8217;s just a matter of looping over the modules and including them in the instance&#8217;s eigenclass one at a time.</p>

<p>So, we have everything working the way we want.  We can define a bunch of context modules, group and name them, and include them as necessary in new instances.  Of course this was just quickly thrown together for the purpose of demonstration, but the idea of decomposition and applying &#8216;roles&#8217; or context to model instances is a powerful one.
We&#8217;ve been employing similar ideas at work for some time now and it has managed to keep our model code very concise and understandable.</p>

<p>The only downside that I&#8217;ve noticed is negated by a decent text editor, and that is navigating the source.  Sometimes it can be a bit difficult to figure out just where a method is defined with all these modules everywhere, so a &#8216;jump to definition&#8217; button is priceless.</p>

<p>You can check out the full source code on my <a href="https://github.com/jmartin2683/contextual">Github</a>, or try it out with &#8216;gem install contextual_models&#8217;.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">James Martin</span></span>

      








  


<time datetime="2012-12-24T17:59:00-05:00" pubdate data-updated="true">Dec 24<span>th</span>, 2012</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.thoughtsonrails.com/giving-rails-some-context/" data-via="xjamesm" data-counturl="http://www.thoughtsonrails.com/giving-rails-some-context/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
      
        <a class="basic-alignment left" href="/apps-for-rails-developers/" title="Previous Post: apps for rails developers">&laquo; apps for rails developers</a>
      
      
    </p>
  </footer>
</article>

  <section>
    <h1>Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
  </section>

</div>

<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/giving-rails-some-context/">giving rails some context</a>
      </li>
    
      <li class="post">
        <a href="/apps-for-rails-developers/">apps for rails developers</a>
      </li>
    
      <li class="post">
        <a href="/polymorphic-associations-with-active-record/">polymorphic associations with active record</a>
      </li>
    
      <li class="post">
        <a href="/creating-plugins-for-octopress/">creating plugins for octopress</a>
      </li>
    
      <li class="post">
        <a href="/devise-and-omniauth/">devise and omniauth</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating...</li>
  </ul>
  
  <a href="https://github.com/jmartin2683">@jmartin2683</a> on GitHub
  
  <script type="text/javascript">
    $.domReady(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'jmartin2683',
            count: 0,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>


<section>
  <h1>Latest Tweets</h1>
  <ul id="tweets">
    <li class="loading">Status updating...</li>
  </ul>
  <script type="text/javascript">
    $.domReady(function(){
      getTwitterFeed("xjamesm", 4, false);
    });
  </script>
  <script src="/javascripts/twitter.js" type="text/javascript"> </script>
  
    <a href="http://twitter.com/xjamesm" class="twitter-follow-button" data-show-count="false">Follow @xjamesm</a>
  
</section>





  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2012 - James Martin -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'thoughtsonrails';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.thoughtsonrails.com/giving-rails-some-context/';
        var disqus_url = 'http://www.thoughtsonrails.com/giving-rails-some-context/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>



  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
